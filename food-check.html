<!DOCTYPE html>
<html>
    <head>
        <title>David O'Donohue | Food Check</title>
        <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' >
        <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
        <link rel="manifest" href="./site.webmanifest">
        <link rel="mask-icon" href="./safari-pinned-tab.svg" color="#5bbad5">
        <meta name="msapplication-TileColor" content="#da532c">
        <meta name="theme-color" content="#ffffff">
        <script src="https://cdn.jsdelivr.net/npm/vue"></script>
        <script src="./components/Tracker.js"></script>
        <script src="./components/SavedFood.js"></script>
        <script src="./components/TrackedItem.js"></script>
        <link href="./assets/css/all.css" rel="stylesheet">
    </head>
    <body>
        <div id ='app'>
            <input type='text' ref='input' v-model='inputData.name' placeholder='Food name' />
            <input type='number' v-model='inputData.carbsPer100g' placeholder='Carbs per 100g' />
            <input type='number' v-model='inputData.proteinPer100g' placeholder='Protein per 100g' />
            <input type='number' v-model='inputData.fatPer100g' placeholder='Fat per 100g' />
            <input type='number' v-model='inputData.costPerItem' placeholder='Cost per item' />
            <input type='number' v-model='inputData.gramsPerItem' placeholder='Grams per item' @keydown.enter="save"/>
            <button @click="save" class='save'><i class="far fa-save"></i> Save Item</button>
            <hr>
            <div class="tracker">
                Tracker<br>
                <input type='number' v-model='trackerData.userBodyWeight' placeholder='Bodyweight in kgs' />
                <span v-if="trackerData.userBodyWeight">Target protein per day: {{Math.round(targetProteinDay)}}</span><br>
                <input type='number' v-model='trackerData.userMealsPerDay' placeholder='Meals per day' />
                <span v-if="trackerData.userMealsPerDay">Target protein per meal: {{Math.round(targetProteinMeal)}}</span><br>
                Calories eaten today: {{Math.round(trackedCalories)}}<br>
                Protein eaten today: {{Math.round(trackedProtein)}}<br>
                <tracked-item v-for="(item, index) in trackerData.trackedFood" :key="index" :item="item" :index="index" @remove-tracked-item="removeTrackedItem"></tracked-item>
                <button @click="clearTracker" class='remove'><i class="fas fa-trash"></i> Reset tracker</button>
            </div>
            <hr>
            Sort food by: <select v-model="sortBy">
                <option>Percent protein</option>
                <option>Cost of protein</option>
                <option>Caloric density</option>
            </select>
            <saved-food class="savedFood" v-for="(elem, index) in savedFood" :data="elem" :index="index" @remove="remove" @edit="edit" @add-to-tracker="addToTracker" :hr="index != savedFood.length - 1"></saved-food>
        </div>
    </body>
</html>

<script>

app = new Vue({
        el: '#app',
        data () {
            return {
                savedFood: [],
                sortBy: null,
                inputData: {
                    carbsPer100g: null,
                    proteinPer100g: null,
                    fatPer100g: null,
                    name: null,
                    costPerItem: null,
                    gramsPerItem: null
                },
                trackerData: {
                    showTracker: false,
                    trackedFood: [],
                    userBodyWeight: null,
                    userMealsPerDay: null
                }
            }
        },
        methods: {
            printData(){
                console.log("Data: ", this.trackerData.trackedFood);
            },
            save(){
                this.savedFood.push({
                    ...this.inputData,
                    costPerProtein: this.costPerProtein,
                    proteinPerItem: this.proteinPerItem,
                    caloriesPerItem: this.caloriesPerItem,
                    proteinPercent: this.proteinPercent,
                    caloriesPer100g: this.caloriesPer100g,
                });
                this.inputData.name = null;
                this.inputData.carbsPer100g = null;
                this.inputData.proteinPer100g = null;
                this.inputData.fatPer100g = null;
                this.inputData.costPerItem = null;
                this.inputData.gramsPerItem = null;
                this.sortList();
                this.updateStorage();
            },
            remove(index){
                this.savedFood.splice(index, 1);
                this.sortList();
                this.updateStorage();
            },
            edit(data){
                this.inputData = {...this.inputData, ...data}
            },
            updateStorage(){
                localStorage.savedFood = JSON.stringify(this.savedFood);
                localStorage.sortBy = this.sortBy;
                localStorage.trackerData = JSON.stringify(this.trackerData);
            },
            sortList() {
                if (this.sortBy == 'Percent protein'){
                        this.savedFood.sort(function(a,b){
                            if(a.proteinPercent && b.proteinPercent){
                                return b.proteinPercent - a.proteinPercent;
                            } else {
                                return 1
                            }
                        });
                    } else if (this.sortBy == 'Cost of protein'){
                        this.savedFood.sort(function(a,b){
                            if(a.costPerProtein && b.costPerProtein){
                                return a.costPerProtein - b.costPerProtein;
                            } else {
                                return 1;
                            }
                        });
                    } else if (this.sortBy == 'Caloric density') {
                        this.savedFood.sort(function(a,b){
                            if(a.caloriesPer100g && b.caloriesPer100g){
                                return a.caloriesPer100g - b.caloriesPer100g;
                            } else {
                                return 1;
                            }
                        });
                    }
            },
            toggleTracker() {
                this.trackerData.showTracker = !this.trackerData.showTracker;
            },
            addToTracker(object, amountAdded){
                this.trackerData.trackedFood.push({
                    ...object,
                    amount: amountAdded
                })
                this.updateStorage();
                // if (this.trackerData.trackedFood.hasOwnProperty(object.name)){
                //     this.trackerData.trackedFood[object.name] = {
                //         ...object,
                //         amount: parseInt(amountAdded) + this.trackerData.trackedFood[object.name].amount
                //     }
                // } else {
                //     this.trackerData.trackedFood[object.name] = {
                //         ...object,
                //         amount: parseInt(amountAdded)
                //     };
                // }
            },
            clearTracker(){
                this.trackerData.trackedFood = [];
            },
            removeTrackedItem(index){
                this.trackerData.trackedFood.splice(index, 1);
                this.updateStorage();
            }
        },
        mounted() {
            if (localStorage.savedFood){
                this.savedFood = JSON.parse(localStorage.savedFood);
            }
            if (localStorage.sortBy){
                this.sortBy = localStorage.sortBy;
            }
            if (localStorage.trackerData){
                this.trackerData = JSON.parse(localStorage.trackerData);
            }
        },
        computed: {
            proteinPercent: function() {
                return (this.inputData.carbsPer100g && this.inputData.proteinPer100g && this.inputData.fatPer100g) ? Math.round(this.inputData.proteinPer100g * 400 / (this.inputData.carbsPer100g * 4 + this.inputData.proteinPer100g * 4 + this.inputData.fatPer100g * 4)) : 0;
            },
            caloriesPer100g: function() {
                return (this.inputData.carbsPer100g * 4 + this.inputData.proteinPer100g * 4 + this.inputData.fatPer100g * 4)
            },
            costPerProtein: function() {
                if (this.inputData.costPerItem && this.inputData.gramsPerItem){
                    return ((this.inputData.costPerItem * 10000) / (this.inputData.gramsPerItem * this.inputData.proteinPer100g));
                } else {
                    return 0;
                }
            },
            proteinPerItem: function(){
                if (this.inputData.proteinPer100g && this.inputData.gramsPerItem){
                    return (this.inputData.proteinPer100g * (this.inputData.gramsPerItem / 100))
                } else {
                    return 0;
                }
            },
            caloriesPerItem: function(){
                if (this.inputData.gramsPerItem){
                    return ((this.caloriesPer100g * this.inputData.gramsPerItem) / 100); 
                } else {
                    return 0;
                }
            },
            trackedCalories: function(){
                var rtn = 0;
                for (let i = 0; i < this.trackerData.trackedFood.length; i++){
                    var item = this.trackerData.trackedFood[i]
                    rtn += (item.caloriesPer100g * item.amount / 100);
                }
                return rtn;
            },
            trackedProtein: function(){
                var rtn = 0;
                for (let i = 0; i < this.trackerData.trackedFood.length; i++){
                    var item = this.trackerData.trackedFood[i]
                    rtn += (item.proteinPer100g * item.amount / 100);
                }
                return rtn;
            },
            targetProteinDay: function(){
                return this.trackerData.userBodyWeight ? (this.trackerData.userBodyWeight * 1.6) : 0;
            },
            targetProteinMeal: function (){
                return this.trackerData.userMealsPerDay ? (this.targetProteinDay / this.trackerData.userMealsPerDay) : 0;
            }
        },
        watch: {
            sortBy: function(val){
                this.sortList();
                this.updateStorage();
            },
        }
    });

</script>

<style>

    :root {
        --primary: #bb86fc;
        --primary-variant: #3700b3;
        --secondary: #03dac6;
        --background00: #121212;
        --background01: #1d1d1d;
        --background02: #212121;
        --background03: #242424;
        --background04: #272727;
        --background06: #2c2c2c;
        --background08: #2d2d2d;
        --background12: #323232;
        --background16: #353535;
        --background24: #383838;
        --error: #cf6679;
        --text: #eee;
    }

    body {
        background-color: var(--background00);
        color: var(--text);
        font-family: Arial, Helvetica, sans-serif;
        font-size: x-large;
        display: flex;
        flex-direction: column;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .dataEntry {
        display: flex;
        flex-direction: column;
        flex-wrap: wrap;
    }

    .savedFood {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        word-break: break-word;
    }

    hr {
        border: 2px solid var(--background24);
        border-radius: 2px;
        margin-left: 0;
        margin-right: 0;
        border-color: var(--secondary);
    }

    input {
        padding: 15px;
        box-sizing: border-box;
        background-color: var(--background01);
        color: var(--text);
        font-weight: bold;
        margin: 1px;
    }

    select, option {
        padding: 15px;
        box-sizing: border-box;
        background-color: var(--background01);
        color: var(--text);
        font-weight: bold;
        margin: 1px;
    }
    
    button.remove {
        background-color: var(--error);
        border: none;
        color: var(--background00);
        padding: 5px 10px;
        text-align: center;
        text-decoration: none;
        font-size: 16px;
        border-radius: 10px;
        margin: 10px;
        transition-duration: 0.4s;
        max-height: 50px;
    }
    
    button.save {
        background-color: var(--primary);
        border: none;
        color: var(--background00);
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        font-size: 16px;
        border-radius: 10px;
        margin: 10px;
        transition-duration: 0.4s;
    }

    button.edit {
        background-color: var(--secondary);
        border: none;
        color: var(--background00);
        padding: 5px 10px;
        text-align: center;
        text-decoration: none;
        font-size: 16px;
        border-radius: 10px;
        margin: 10px;
        transition-duration: 0.4s;
        max-height: 50px;
    }

    button.selectedOrder{
        background-color: var(--primary-variant);
        color: var(--text);
    }

    button.save:hover {
        background-color: var(--primary-variant);
        color: var(--text);
    }

    @keyframes animation {
        from {
            filter: blur(5px);
            opacity: 0;
        } to {
            filter: blur(0px);
            opacity: 1;
        }
    }

    .savedFood, .foodItem, hr {
        animation: animation 1s ease-in-out 1 normal;
    }

    @media only screen and (min-width: 990px) {
        
    }

    .component-fade {
        opacity: 1;
        filter: blur(0px);
    }

    .component-fade-enter-active, .component-fade-leave-active {
        transition: all 1s ease;
    }
    .component-fade-enter, .component-fade-leave-to {
        opacity: 0;
        filter: blur(5px);
    }

    /* Extra small devices (phones, 600px and down)
    @media only screen and (max-width: 600px) {

    }

    /* Small devices (portrait tablets and large phones, 600px and up) 
    @media only screen and (min-width: 600px) {

    }

    /* Medium devices (landscape tablets, 768px and up)
    @media only screen and (min-width: 768px) {

    }

    /* Large devices (laptops/desktops, 992px and up)
    @media only screen and (min-width: 992px) {

    }

    /* Extra large devices (large laptops and desktops, 1200px and up) 
    @media only screen and (min-width: 1200px) {

    }*/
    
</style>
