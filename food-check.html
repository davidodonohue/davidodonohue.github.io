<!DOCTYPE html>
<html>
    <head>
        <title>David O'Donohue | Food Check</title>
        <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' >
        <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
        <link rel="manifest" href="./site.webmanifest">
        <link rel="mask-icon" href="./safari-pinned-tab.svg" color="#5bbad5">
        <meta name="msapplication-TileColor" content="#da532c">
        <meta name="theme-color" content="#ffffff">
        <script src="https://cdn.jsdelivr.net/npm/vue"></script>
        <script src="./components/SavedFood.js"></script>
        <script src="./components/MixFood.js"></script>
        <link href="./assets/css/all.css" rel="stylesheet">
    </head>
    <body>
        <div id ='app'>
            <input type='text' ref='input' v-model='inputData.name' placeholder='Food name' />
            <input type='number' v-model='inputData.carbsPer100g' placeholder='Carbs per 100g' />
            <input type='number' v-model='inputData.proteinPer100g' placeholder='Protein per 100g' />
            <input type='number' v-model='inputData.fatPer100g' placeholder='Fat per 100g' />
            <input type='number' v-model='inputData.costPerItem' placeholder='Cost per item' />
            <input type='number' v-model='inputData.gramsPerItem' placeholder='Grams per item' @keydown.enter="save"/>
            <button @click="save" class='save'><i class="far fa-save"></i> Save Food</button>
            <hr>
            <div class="mix">
                Mixer<br>
                <input type='number' v-model='mixData.userBodyWeight' placeholder='Bodyweight in kgs' /><br>
                <span v-if="mixData.userBodyWeight">Target protein per day: {{Math.round(targetProteinDay)}}<br></span>
                <input type='number' v-model='mixData.userMealsPerDay' placeholder='Meals per day' /><br>
                <span v-if="mixData.userMealsPerDay">Target protein per meal: {{Math.round(targetProteinMeal)}}<br></span>
                Mixer contains:<br>
                {{Math.round(mixCalories)}} calories<br>
                {{Math.round(mixProtein)}} grams of protein<br>
                {{Math.round(mixProteinPercent)}}% of calories from protein<br>
                <span v-if="mixCostPerProtein">${{parseFloat(mixCostPerProtein).toFixed(2)}} per 100g of protein<br></span>
                <mix-food v-for="(food, index) in mixData.mixFood" :key="index" :food="food" :index="index" @remove-mix-food="removeMixFood"></mix-food>
                <button @click="clearMix" class='clearMix'><i class="fas fa-trash"></i> Empty mixer</button>
            </div>
            <hr>
            Sort food by: <select v-model="sortBy">
                <option>Percent protein</option>
                <option>Cost of protein</option>
                <option>Caloric density</option>
            </select>
            <saved-food class="savedFood" v-for="(elem, index) in savedFood" :data="elem" :index="index" @remove="remove" @edit="edit" @add-to-mix="addMix" :hr="index != savedFood.length - 1"></saved-food>
        </div>
    </body>
</html>

<script>

app = new Vue({
        el: '#app',
        data () {
            return {
                savedFood: [],
                sortBy: null,
                inputData: {
                    carbsPer100g: null,
                    proteinPer100g: null,
                    fatPer100g: null,
                    name: null,
                    costPerItem: null,
                    gramsPerItem: null
                },
                mixData: {
                    mixFood: [],
                    userBodyWeight: null,
                    userMealsPerDay: null
                }
            }
        },
        methods: {
            save(){
                this.savedFood.push({
                    ...this.inputData,
                    costPerProtein: this.costPerProtein,
                    proteinPerItem: this.proteinPerItem,
                    caloriesPerItem: this.caloriesPerItem,
                    proteinPercent: this.proteinPercent,
                    caloriesPer100g: this.caloriesPer100g,
                });
                this.inputData.name = null;
                this.inputData.carbsPer100g = null;
                this.inputData.proteinPer100g = null;
                this.inputData.fatPer100g = null;
                this.inputData.costPerItem = null;
                this.inputData.gramsPerItem = null;
                this.sortList();
                this.updateStorage();
            },
            remove(index){
                this.savedFood.splice(index, 1);
                this.sortList();
                this.updateStorage();
            },
            edit(data){
                this.inputData = {...this.inputData, ...data}
            },
            updateStorage(){
                localStorage.savedFood = JSON.stringify(this.savedFood);
                localStorage.sortBy = this.sortBy;
                localStorage.mixData = JSON.stringify(this.mixData);
            },
            sortList() {
                if (this.sortBy == 'Percent protein'){
                    this.savedFood.sort(function(a,b){
                        if(a.proteinPercent && b.proteinPercent){
                            return b.proteinPercent - a.proteinPercent;
                        } else {
                            return 1
                        }
                    });
                } else if (this.sortBy == 'Cost of protein'){
                    this.savedFood.sort(function(a,b){
                        if(a.costPerProtein && b.costPerProtein){
                            return a.costPerProtein - b.costPerProtein;
                        } else {
                            return 1;
                        }
                    });
                } else if (this.sortBy == 'Caloric density') {
                    this.savedFood.sort(function(a,b){
                        if(a.caloriesPer100g && b.caloriesPer100g){
                            return a.caloriesPer100g - b.caloriesPer100g;
                        } else {
                            return 1;
                        }
                    });
                }
            },
            addMix(object, gramsAmount, servesAmount){
                this.mixData.mixFood.push({
                    ...object,
                    amountGrams: gramsAmount,
                    amountServes: servesAmount
                });
                this.updateStorage();
            },
            clearMix(){
                this.mixData.mixFood = [];
            },
            removeMixFood(index){
                this.mixData.mixFood.splice(index, 1);
                this.updateStorage();
            }
        },
        mounted() {
            if (localStorage.savedFood){
                this.savedFood = JSON.parse(localStorage.savedFood);
            }
            if (localStorage.sortBy){
                this.sortBy = localStorage.sortBy;
            }
            if (localStorage.mixData){
                this.mixData = JSON.parse(localStorage.mixData);
            }
        },
        computed: {
            proteinPercent: function() {
                return (this.inputData.carbsPer100g && this.inputData.proteinPer100g && this.inputData.fatPer100g) ? (this.inputData.proteinPer100g * 400 / (this.inputData.carbsPer100g * 4 + this.inputData.proteinPer100g * 4 + this.inputData.fatPer100g * 4)) : 0;
            },
            caloriesPer100g: function() {
                return (this.inputData.carbsPer100g * 4 + this.inputData.proteinPer100g * 4 + this.inputData.fatPer100g * 4)
            },
            costPerProtein: function() {
                if (this.inputData.costPerItem && this.inputData.gramsPerItem){
                    return ((this.inputData.costPerItem * 10000) / (this.inputData.gramsPerItem * this.inputData.proteinPer100g));
                } else {
                    return 0;
                }
            },
            proteinPerItem: function(){
                if (this.inputData.proteinPer100g && this.inputData.gramsPerItem){
                    return (this.inputData.proteinPer100g * (this.inputData.gramsPerItem / 100))
                } else {
                    return 0;
                }
            },
            caloriesPerItem: function(){
                if (this.inputData.gramsPerItem){
                    return ((this.caloriesPer100g * this.inputData.gramsPerItem) / 100); 
                } else {
                    return 0;
                }
            },
            mixCalories: function(){
                var rtn = 0;
                for (let i = 0; i < this.mixData.mixFood.length; i++){
                    var item = this.mixData.mixFood[i]
                    if (item.amountGrams){
                        rtn += (item.caloriesPer100g * item.amountGrams / 100);
                    }
                    if (item.amountServes){
                        rtn += (item.caloriesPerItem * item.amountServes);
                    }
                }
                return rtn;
            },
            mixProtein: function(){
                var rtn = 0;
                for (let i = 0; i < this.mixData.mixFood.length; i++){
                    var item = this.mixData.mixFood[i]
                    if (item.amountGrams){
                        rtn += (item.proteinPer100g * item.amountGrams / 100);
                    }
                    if (item.amountServes){
                        rtn += (item.proteinPerItem * item.amountServes);
                    }
                    
                }
                return rtn;
            },
            mixProteinPercent: function() {
                return (this.mixProtein && this.mixCalories) ? ((this.mixProtein * 400) / this.mixCalories) : 0;
            },
            mixCostPerProtein: function() {
                var costPerProteinArray = [];
                // get cost per protein and number of grams of each food
                for (let i = 0; i < this.mixData.mixFood.length; i++){
                    var item = this.mixData.mixFood[i]
                    if (!item.costPerItem){
                        return null;
                    }
                    if (item.amountGrams){
                        costPerProteinArray.push([item.costPerProtein, item.amountGrams])
                    }
                    if (item.amountServes){
                        costPerProteinArray.push([item.costPerProtein, (item.gramsPerItem * item.amountServes)])
                    }
                }
                var totalGrams = 0;
                var costPerProteinAverage = 0;
                for (let i = 0; i < costPerProteinArray.length; i++){
                    totalGrams += parseInt(costPerProteinArray[i][1]);
                }
                for (let i = 0; i < costPerProteinArray.length; i++){
                    costPerProteinAverage += (costPerProteinArray[i][0] * costPerProteinArray[i][1] / totalGrams);
                }
                return costPerProteinAverage;
            },
            targetProteinDay: function(){
                return this.mixData.userBodyWeight ? (this.mixData.userBodyWeight * 1.6) : 0;
            },
            targetProteinMeal: function (){
                return this.mixData.userMealsPerDay ? (this.targetProteinDay / this.mixData.userMealsPerDay) : 0;
            }
        },
        watch: {
            sortBy: function(val){
                this.sortList();
                this.updateStorage();
            },
        }
    });

</script>

<style>

    :root {
        --primary: #bb86fc;
        --primary-variant: #3700b3;
        --secondary: #03dac6;
        --background00: #121212;
        --background01: #1d1d1d;
        --background02: #212121;
        --background03: #242424;
        --background04: #272727;
        --background06: #2c2c2c;
        --background08: #2d2d2d;
        --background12: #323232;
        --background16: #353535;
        --background24: #383838;
        --error: #cf6679;
        --text: #eee;
    }

    body {
        background-color: var(--background00);
        color: var(--text);
        font-family: Arial, Helvetica, sans-serif;
        font-size: x-large;
        display: flex;
        flex-direction: column;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .dataEntry {
        display: flex;
        flex-direction: column;
        flex-wrap: wrap;
    }

    .savedFood {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        word-break: break-word;
    }

    hr {
        border: 2px solid var(--background24);
        border-radius: 2px;
        margin-left: 0;
        margin-right: 0;
        border-color: var(--secondary);
    }

    input {
        padding: 15px;
        box-sizing: border-box;
        background-color: var(--background01);
        color: var(--text);
        font-weight: bold;
        margin: 1px;
    }

    select, option {
        padding: 15px;
        box-sizing: border-box;
        background-color: var(--background01);
        color: var(--text);
        font-weight: bold;
        margin: 1px;
    }
    
    button.remove {
        background-color: darkred;
        border: none;
        color: white;
        padding: 5px 10px;
        text-align: center;
        text-decoration: none;
        font-size: 16px;
        border-radius: 10px;
        margin: 10px;
        transition-duration: 0.4s;
        max-height: 50px;
    }
    
    button.save {
        background-color: var(--primary);
        border: none;
        color: var(--background00);
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        font-size: 16px;
        border-radius: 10px;
        margin: 10px;
        transition-duration: 0.4s;
    }

    button.edit {
        background-color: darkblue;
        border: none;
        color: white;
        padding: 5px 10px;
        text-align: center;
        text-decoration: none;
        font-size: 16px;
        border-radius: 10px;
        margin: 10px;
        transition-duration: 0.4s;
        max-height: 50px;
    }

    button.clearMix {
        background-color: forestgreen;
        border: none;
        color: white;
        padding: 5px 10px;
        text-align: center;
        text-decoration: none;
        font-size: 16px;
        border-radius: 10px;
        margin: 10px;
        transition-duration: 0.4s;
        max-height: 50px;
    }

    button.removeMix {
        background-color: darkred;
        border: none;
        color: white;
        padding: 5px 10px;
        text-align: center;
        text-decoration: none;
        font-size: 16px;
        border-radius: 10px;
        margin: 10px;
        transition-duration: 0.4s;
        max-height: 50px;
    }

    button.mix {
        background-color: darkviolet;
        border: none;
        color: white;
        padding: 5px 10px;
        text-align: center;
        text-decoration: none;
        font-size: 16px;
        border-radius: 10px;
        margin: 10px;
        transition-duration: 0.4s;
        max-height: 50px;
    }

    button.save:hover {
        background-color: var(--primary-variant);
        color: var(--text);
    }

    @keyframes animation {
        from {
            filter: blur(5px);
            opacity: 0;
        } to {
            filter: blur(0px);
            opacity: 1;
        }
    }

    .savedFood, .foodItem, .mixFood, hr {
        animation: animation 1s ease-in-out 1 normal;
    }

    @media only screen and (min-width: 990px) {
        
    }

    .component-fade {
        opacity: 1;
        filter: blur(0px);
    }

    .component-fade-enter-active, .component-fade-leave-active {
        transition: all 1s ease;
    }
    .component-fade-enter, .component-fade-leave-to {
        opacity: 0;
        filter: blur(5px);
    }

    /* Extra small devices (phones, 600px and down)
    @media only screen and (max-width: 600px) {

    }

    /* Small devices (portrait tablets and large phones, 600px and up) 
    @media only screen and (min-width: 600px) {

    }

    /* Medium devices (landscape tablets, 768px and up)
    @media only screen and (min-width: 768px) {

    }

    /* Large devices (laptops/desktops, 992px and up)
    @media only screen and (min-width: 992px) {

    }

    /* Extra large devices (large laptops and desktops, 1200px and up) 
    @media only screen and (min-width: 1200px) {

    }*/
    
</style>
